
##
#
https://0x00sec.org/t/a-blue-team-guide-to-aws-cloudtrail-monitoring/15086
#
##



| Scenario                          | EventName                        | AWS CLI Command                                                                                                                                                                                                                                                                                                                                                                                      | Splunk Query                                                                                                                                                                                               | Use Case                                                       |
|-----------------------------------|----------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|
| **Successful Console Login**      | `ConsoleLogin`                   | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=ConsoleLogin --region ap-northeast-1 --query 'Events[?ErrorCode==null].{User:Username,Time:EventTime,SourceIP:Resources[0].ResourceName}' --output table`                                                                                                              | `index=cloudtrail EventName="ConsoleLogin" errorCode="" | table userIdentity.userName eventTime sourceIPAddress`                                                               | Identify every successful human/AWS-managed-console login.     |
| **Failed Console Login**          | `ConsoleLogin`                   | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=ConsoleLogin --region ap-northeast-1 --query 'Events[?ErrorCode=="FailedAuthentication"].{User:Username,Time:EventTime,Error:ErrorCode}' --output table`                                                                                                     | `index=cloudtrail EventName="ConsoleLogin" errorCode="FailedAuthentication" | table userIdentity.userName eventTime errorCode`                                                     | Detect brute-force or forgotten-password attempts.             |
| **EC2 Instance Stop**             | `StopInstances`                  | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=StopInstances --region ap-northeast-1 --query 'Events[*].{User:Username,Time:EventTime,Instance:Resources[0].ResourceName}' --output table`                                                                                                            | `index=cloudtrail EventName="StopInstances" | spath output=instanceId responseElements.instancesSet.items{}.instanceId | table userIdentity.userName eventTime instanceId`               | Find who stopped EC2 instances (could indicate disruption).    |
| **EC2 Instance Start**            | `StartInstances`                 | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=StartInstances --region ap-northeast-1 --query 'Events[*].{User:Username,Time:EventTime,Instance:Resources[0].ResourceName}' --output table`                                                                                                           | `index=cloudtrail EventName="StartInstances" | spath output=instanceId responseElements.instancesSet.items{}.instanceId | table userIdentity.userName eventTime instanceId`               | Track unexpected EC2 power-ups or recovery actions.            |
| **EC2 RunInstances**              | `RunInstances`                   | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=RunInstances --region ap-northeast-1 --query 'Events[*].{User:Username,Time:EventTime,Image:ResponseElements.instancesSet.items[0].imageId,Instance:ResponseElements.instancesSet.items[0].instanceId}' --output table`                                     | `index=cloudtrail EventName="RunInstances" | spath output=imageId responseElements.instancesSet.items{}.imageId | spath output=instanceId responseElements.instancesSet.items{}.instanceId | table userIdentity.userName eventTime imageId instanceId` | Detect launching of EC2 instances from unapproved or trojaned AMIs. |
| **IAM User Creation**             | `CreateUser`                     | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=CreateUser --region ap-northeast-1 --query 'Events[*].{Admin:Username,Time:EventTime,NewUser:ResponseElements.user.userName}' --output table`                                                                                                              | `index=cloudtrail EventName="CreateUser" | spath output=newUser responseElements.user.userName | table userIdentity.userName eventTime newUser`                                                        | Audit who’s provisioning new IAM users.                        |
| **IAM User Deletion**             | `DeleteUser`                     | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=DeleteUser --region ap-northeast-1 --query 'Events[*].{Admin:Username,Time:EventTime,DeletedUser:RequestParameters.userName}' --output table`                                                                                                                | `index=cloudtrail EventName="DeleteUser" | spath output=deletedUser requestParameters.userName | table userIdentity.userName eventTime deletedUser`                                                | Detect potential cover-ups or deprovisioning mistakes.         |
| **Attach Role Policy**            | `AttachRolePolicy`               | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=AttachRolePolicy --region ap-northeast-1 --query 'Events[*].{Admin:Username,Time:EventTime,Role:RequestParameters.roleName,PolicyArn:RequestParameters.policyArn}' --output table`                                                                     | `index=cloudtrail EventName="AttachRolePolicy" | spath output=roleName requestParameters.roleName | spath output=policyArn requestParameters.policyArn | table userIdentity.userName eventTime roleName policyArn`  | See who’s granting new permissions to roles.                   |
| **Detach Role Policy**            | `DetachRolePolicy`               | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=DetachRolePolicy --region ap-northeast-1 --query 'Events[*].{Admin:Username,Time:EventTime,Role:RequestParameters.roleName,PolicyArn:RequestParameters.policyArn}' --output table`                                                                     | `index=cloudtrail EventName="DetachRolePolicy" | spath output=roleName requestParameters.roleName | spath output=policyArn requestParameters.policyArn | table userIdentity.userName eventTime roleName policyArn`  | Monitor removal of privileges from roles.                      |
| **Assume Role**                   | `AssumeRole`                     | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=AssumeRole --region ap-northeast-1 --query 'Events[*].{Caller:Username,Time:EventTime,Role:RequestParameters.roleArn}' --output table`                                                                                 | `index=cloudtrail EventName="AssumeRole" | spath output=roleArn requestParameters.roleArn | table userIdentity.userName eventTime roleArn`                                             | Track cross-account or service-account impersonation.          |
| **S3 Bucket Policy Change**       | `PutBucketPolicy`                | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=PutBucketPolicy --region ap-northeast-1 --query 'Events[*].{Admin:Username,Time:EventTime,Bucket:RequestParameters.bucketName}' --output table`                                                             | `index=cloudtrail EventName="PutBucketPolicy" | spath output=bucketName requestParameters.bucketName | table userIdentity.userName eventTime bucketName`                                             | Detect modifications to S3 access controls.                    |
| **Security Group Ingress Added**  | `AuthorizeSecurityGroupIngress`  | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=AuthorizeSecurityGroupIngress --region ap-northeast-1 --query 'Events[*].{Admin:Username,Time:EventTime,Group:RequestParameters.groupId,Cidr:RequestParameters.ipPermissions[0].ipRanges[0].cidrIp}' --output table` | `index=cloudtrail EventName="AuthorizeSecurityGroupIngress" | spath output=groupId requestParameters.groupId | spath output=cidrIp requestParameters.ipPermissions{}.ipRanges{}.cidrIp | table userIdentity.userName eventTime groupId cidrIp` | Catch opening of new network paths to hosts.                  |
| **Unauthorized API Call**         | any + `ErrorCode=UnauthorizedOperation` | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=ErrorCode,AttributeValue=UnauthorizedOperation --region ap-northeast-1 --query 'Events[*].{User:Username,Time:EventTime,Operation:EventName}' --output table`                                                                                  | `index=cloudtrail errorCode="UnauthorizedOperation" | table userIdentity.userName eventTime eventName`                                               | Surface attempts to call APIs without proper rights.          |
| **SSM Session Start**             | `StartSession`                   | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=StartSession --region ap-northeast-1 --query 'Events[*].{User:Username,Time:EventTime,Target:RequestParameters.target}' --output table`                                                                      | `index=cloudtrail EventName="StartSession" | spath output=target requestParameters.target | table userIdentity.userName eventTime target`                                           | Detect interactive remote shell via SSM Session Manager.       |
| **SSM Command Execution**         | `SendCommand`                    | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=SendCommand --region ap-northeast-1 --query 'Events[*].{Admin:Username,Time:EventTime,Document:RequestParameters.documentName,Targets:RequestParameters.targets}' --output table`                            | `index=cloudtrail EventName="SendCommand" | spath output=documentName requestParameters.documentName | spath output=targets requestParameters.targets | table userIdentity.userName eventTime documentName targets`         | Identify remote commands executed via SSM RunCommand.          |
| **AMI Registration**              | `RegisterImage`                  | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=RegisterImage --region ap-northeast-1 --query 'Events[*].{User:Username,Time:EventTime,ImageId:ResponseElements.imageId}' --output table`                                                                      | `index=cloudtrail EventName="RegisterImage" | spath output=imageId responseElements.imageId | table userIdentity.userName eventTime imageId`                                       | Identify creation of potentially trojaned custom AMIs.         |
| **AMI Deregistration**            | `DeregisterImage`                | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=DeregisterImage --region ap-northeast-1 --query 'Events[*].{User:Username,Time:EventTime,ImageId:RequestParameters.imageId}' --output table`                                                                  | `index=cloudtrail EventName="DeregisterImage" | spath output=imageId requestParameters.imageId | table userIdentity.userName eventTime imageId`                                          | Detect removal of AMIs (cover-up or cleanup).                  |
| **ECR Image Push**                | `PutImage`                       | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=PutImage --region ap-northeast-1 --query 'Events[*].{User:Username,Time:EventTime,Repository:RequestParameters.repositoryName,ImageTag:RequestParameters.imageTag}' --output table`                          | `index=cloudtrail EventName="PutImage" | spath output=repositoryName requestParameters.repositoryName | spath output=imageTag requestParameters.imageTag | table userIdentity.userName eventTime repositoryName imageTag`        | Identify new or updated container image uploads (potentially trojaned). |
| **ECR Image Delete**              | `BatchDeleteImage`               | `aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=BatchDeleteImage --region ap-northeast-1 --query 'Events[*].{User:Username,Time:EventTime,Repository:RequestParameters.repositoryName,ImageIds:RequestParameters.imageIds}' --output table`              | `index=cloudtrail EventName="BatchDeleteImage" | spath output=repositoryName requestParameters.repositoryName | spath output=imageIds requestParameters.imageIds | table userIdentity.userName eventTime repositoryName imageIds`        | Detect removal of container images (cover‐up).                 |
