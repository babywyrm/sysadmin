apacheConfiguration: |
  ServerRoot "/opt/bitnami/apache"
  Listen 8080

  # --- Core Modules ---
  LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
  LoadModule authn_file_module modules/mod_authn_file.so
  LoadModule authn_core_module modules/mod_authn_core.so
  LoadModule authz_host_module modules/mod_authz_host.so
  LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
  LoadModule authz_user_module modules/mod_authz_user.so
  LoadModule authz_core_module modules/mod_authz_core.so
  LoadModule access_compat_module modules/mod_access_compat.so
  LoadModule auth_basic_module modules/mod_auth_basic.so
  LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
  LoadModule reqtimeout_module modules/mod_reqtimeout.so
  LoadModule filter_module modules/mod_filter.so
  LoadModule deflate_module modules/mod_deflate.so
  LoadModule mime_module modules/mod_mime.so
  LoadModule log_config_module modules/mod_log_config.so
  LoadModule env_module modules/mod_env.so
  LoadModule headers_module modules/mod_headers.so
  LoadModule setenvif_module modules/mod_setenvif.so
  LoadModule version_module modules/mod_version.so
  LoadModule proxy_module modules/mod_proxy.so
  LoadModule proxy_connect_module modules/mod_proxy_connect.so
  LoadModule proxy_http_module modules/mod_proxy_http.so
  LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
  LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
  LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
  LoadModule slotmem_shm_module modules/mod_slotmem_shm.so
  LoadModule ssl_module modules/mod_ssl.so
  LoadModule unixd_module modules/mod_unixd.so
  LoadModule status_module modules/mod_status.so
  LoadModule autoindex_module modules/mod_autoindex.so
  LoadModule negotiation_module modules/mod_negotiation.so
  LoadModule dir_module modules/mod_dir.so
  LoadModule alias_module modules/mod_alias.so
  LoadModule rewrite_module modules/mod_rewrite.so
  LoadModule php_module modules/libphp.so

  <IfModule unixd_module>
    User daemon
    Group daemon
  </IfModule>

  ServerAdmin you@example.com
  ServerName localhost:8080

  <Directory />
    AllowOverride none
    Require all denied
  </Directory>

  DocumentRoot "/opt/bitnami/apache/htdocs"
  <Directory "/opt/bitnami/apache/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>

  <IfModule dir_module>
    DirectoryIndex index.html
  </IfModule>

  <Files ".ht*">
    Require all denied
  </Files>

  # --- Logging to stdout/stderr for Kubernetes ---
  LogLevel warn

  <IfModule log_config_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined

    <IfModule logio_module>
      LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
    </IfModule>
  </IfModule>

  ErrorLog "/proc/self/fd/2"
  CustomLog "/proc/self/fd/1" common

  <IfModule headers_module>
    RequestHeader unset Proxy early
  </IfModule>

  # --- Bitnami Includes ---
  Include "/opt/bitnami/apache/conf/deflate.conf"
  IncludeOptional "/opt/bitnami/apache/conf/vhosts/*.conf"
  Include "/opt/bitnami/apache/conf/bitnami/bitnami.conf"
  Include "/opt/bitnami/apache/conf/bitnami/php.conf"

  ######################################################################
  # Custom Protections
  ######################################################################

  # 1. Protect against slowloris / slow POST floods
  <IfModule reqtimeout_module>
    # Headers must complete within 5â€“10s, body within 10s
    RequestReadTimeout header=5-10,MinRate=1000 body=10,MinRate=1000
  </IfModule>

  # 2. Block common fuzzers/scanners and sensitive files
  <IfModule rewrite_module>
    RewriteEngine On

    # Block common fuzzing/scanning tools by User-Agent
    RewriteCond %{HTTP_USER_AGENT} (ffuf|gobuster|dirbuster|nikto|sqlmap|nmap|wpscan) [NC]
    RewriteRule .* - [F,L]

    # Block sensitive files
    RewriteRule ^(wp-config\.php|xmlrpc\.php|\.git|\.env) - [F,L]
  </IfModule>

  # 3. Basic per-IP throttling (rewrite hack with reset)
  <IfModule rewrite_module>
    RewriteEngine On

    # If an IP has made more than 20 requests in this worker, block it
    RewriteCond %{ENV:REQS_%{REMOTE_ADDR}} >20
    RewriteRule .* - [F,L]

    # Initialize counter if empty
    RewriteCond %{ENV:REQS_%{REMOTE_ADDR}} =""
    RewriteRule .* - [E=REQS_%{REMOTE_ADDR}:1,E=TS_%{REMOTE_ADDR}:%{TIME}]

    # Increment counter otherwise
    RewriteCond %{ENV:REQS_%{REMOTE_ADDR}} !=""
    RewriteRule .* - [E=REQS_%{REMOTE_ADDR}:%{ENV:REQS_%{REMOTE_ADDR}}+1]

    # Reset counter if more than 30 seconds have passed
    RewriteCond %{ENV:TS_%{REMOTE_ADDR}} <%{TIME}-30
    RewriteRule .* - [E=REQS_%{REMOTE_ADDR}:1,E=TS_%{REMOTE_ADDR}:%{TIME}]
  </IfModule>

  # 4. (Optional) Enable mod_ratelimit later
  #
  #LoadModule ratelimit_module modules/mod_ratelimit.so
  #<IfModule ratelimit_module>
  #  <Location "/">
  #    SetOutputFilter RATE_LIMIT
  #    SetEnv rate-limit 400
  #  </Location>
  #</IfModule>
