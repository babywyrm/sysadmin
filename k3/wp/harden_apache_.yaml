## helm values__yaml ##
## beware of spacing ##

apacheConfiguration: |
  ServerRoot "/opt/bitnami/apache"
  Listen 8080

  # --- Core Modules ---
  LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
  LoadModule authn_file_module modules/mod_authn_file.so
  LoadModule authn_core_module modules/mod_authn_core.so
  LoadModule authz_host_module modules/mod_authz_host.so
  LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
  LoadModule authz_user_module modules/mod_authz_user.so
  LoadModule authz_core_module modules/mod_authz_core.so
  LoadModule access_compat_module modules/mod_access_compat.so
  LoadModule auth_basic_module modules/mod_auth_basic.so
  LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
  LoadModule reqtimeout_module modules/mod_reqtimeout.so
  LoadModule filter_module modules/mod_filter.so
  LoadModule deflate_module modules/mod_deflate.so
  LoadModule mime_module modules/mod_mime.so
  LoadModule log_config_module modules/mod_log_config.so
  LoadModule env_module modules/mod_env.so
  LoadModule headers_module modules/mod_headers.so
  LoadModule setenvif_module modules/mod_setenvif.so
  LoadModule version_module modules/mod_version.so
  LoadModule proxy_module modules/mod_proxy.so
  LoadModule proxy_connect_module modules/mod_proxy_connect.so
  LoadModule proxy_http_module modules/mod_proxy_http.so
  LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
  LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
  LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
  LoadModule slotmem_shm_module modules/mod_slotmem_shm.so
  LoadModule ssl_module modules/mod_ssl.so
  LoadModule unixd_module modules/mod_unixd.so
  LoadModule status_module modules/mod_status.so
  LoadModule autoindex_module modules/mod_autoindex.so
  LoadModule negotiation_module modules/mod_negotiation.so
  LoadModule dir_module modules/mod_dir.so
  LoadModule alias_module modules/mod_alias.so
  LoadModule rewrite_module modules/mod_rewrite.so
  LoadModule php_module modules/libphp.so
  LoadModule ratelimit_module modules/mod_ratelimit.so

  <IfModule unixd_module>
    User daemon
    Group daemon
  </IfModule>

  ServerAdmin you@example.com
  ServerName localhost:8080

  <Directory />
    AllowOverride none
    Require all denied
  </Directory>

  DocumentRoot "/opt/bitnami/apache/htdocs"
  <Directory "/opt/bitnami/apache/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>

  <IfModule dir_module>
    DirectoryIndex index.html
  </IfModule>

  <Files ".ht*">
    Require all denied
  </Files>

  # --- Logging to stdout/stderr for Kubernetes ---
  LogLevel warn

  <IfModule log_config_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
  </IfModule>

  ErrorLog "/proc/self/fd/2"
  CustomLog "/proc/self/fd/1" common

  <IfModule headers_module>
    RequestHeader unset Proxy early
  </IfModule>

  # --- Bitnami Includes (must come before our overrides) ---
  Include "/opt/bitnami/apache/conf/deflate.conf"
  IncludeOptional "/opt/bitnami/apache/conf/vhosts/*.conf"
  Include "/opt/bitnami/apache/conf/bitnami/bitnami.conf"
  Include "/opt/bitnami/apache/conf/bitnami/php.conf"

  ######################################################################
  # Custom Protections (AFTER includes so they override)
  ######################################################################

  # 1. Protect against slowloris / slow POST floods
  <IfModule reqtimeout_module>
    RequestReadTimeout header=5-10,MinRate=1500 body=10,MinRate=1500
  </IfModule>

  # 2. Block common fuzzers/scanners and sensitive files
  <IfModule rewrite_module>
    RewriteEngine On
    RewriteCond %{HTTP_USER_AGENT} (ffuf|gobuster|dirbuster|nikto|sqlmap|nmap|wpscan) [NC]
    RewriteRule .* - [F,L]
    RewriteRule ^(wp-config\.php|\.git|\.env) - [F,L]
    RewriteRule \.(bak|old|swp|inc|conf|log|sql|tar|gz|zip)$ - [F,L]
  </IfModule>

  # 3. Throttle WordPress attack surfaces
  <IfModule ratelimit_module>
    <Location "/wp-login.php">
      SetOutputFilter RATE_LIMIT
      SetEnv rate-limit 50
    </Location>
    <Location "/xmlrpc.php">
      Require all denied
    </Location>
  </IfModule>

  # 4. Block plugin and theme enumeration
  <IfModule rewrite_module>
    RewriteEngine On
    RewriteCond %{REQUEST_URI} ^/wp-content/plugins/ [NC]
    RewriteRule .* - [F,L]
    RewriteCond %{REQUEST_URI} ^/wp-content/themes/ [NC]
    RewriteRule .* - [F,L]
    # Block plugin/theme readmes and changelogs
    RewriteRule ^wp-content/.*/readme\.txt$ - [F,L]
    RewriteRule ^wp-content/.*/changelog\.txt$ - [F,L]
  </IfModule>

  # 5. Anti-ffuf protections
  <IfModule ratelimit_module>
    # Global ratelimit: slow down all responses
    <Location "/">
      SetOutputFilter RATE_LIMIT
      SetEnv rate-limit 50
    </Location>
  </IfModule>

  <IfModule reqtimeout_module>
    # Force fast headers, drop slow fuzzers
    RequestReadTimeout header=5-10,MinRate=2000 body=5,MinRate=2000
  </IfModule>

  # Deny HEAD and other uncommon methods
  <Location "/">
    <LimitExcept GET POST>
      Require all denied
    </LimitExcept>
  </Location>

  ######################################################################
  # Final Hardening Overrides (must be last)
  ######################################################################

  # Block wp-cron.php
  <Location "/wp-cron.php">
    Require all denied
  </Location>

  # Block readme/license
  <FilesMatch "^(readme\.html|license\.txt)$">
    Require all denied
  </FilesMatch>

  # Block installer
  <Location "/wp-admin/install.php">
    Require all denied
  </Location>

  # Block feeds (stop version fingerprinting)
  <Location "/feed/">
    Require all denied
  </Location>
  <Location "/comments/feed/">
    Require all denied
  </Location>
